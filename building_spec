<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/raphael.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.mousewheel.js"></script>
<script type="text/javascript" src="/mm_svgmap.js"></script>
<div class="inside_banner">   
    <div class="content_container">
        <div class="inside_banner_content">
            <div class="row">
                <div class="col-md-6">
                    <h1>Centre Map</h1>
                </div>
                <div class="col-md-6 hidden_phone">
                    <h4 class="pull-right">Stores <i class="fa fa-angle-right" aria-hidden="true"></i> Centre Map</h4>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="content_container margin_30">
    <div class="margin_30"></div>
    <!--<div class="row">-->
    <!--    <div class="col-md-12 center hidden_phone">-->
    <!--        <a href="/stores"><div class="directory_btn caps ">Stores</div></a>-->
    <!--        <div class="directory_btn caps active">Centre Map</div>-->
    <!--    </div>-->
    <!--    <div class="col-sm-12 center">-->
    <!--        <a href="/stores"><div class="directory_btn caps directory_back"><i class="fa fa-angle-left" aria-hidden="true"></i> Back to Directory</div></a>-->
    <!--    </div>-->
    <!--</div>-->
    <div class="margin_30"></div>
    <div class="row">
        <div class="col-sm-4"> 
            <div class="stores_list">
                <ul id="store_list_building_spec">
                    <script id="store_list_template_map" type="x-tmpl-mustache/text">
                        <li><a class="map_pin_a" href="#" data-value='{{svgmap_region}}/{{unit_number}}'>{{unit_number}}</a><li>
                    </script>
                </ul>
            </div>
            <div>
                <h3 class="unit_name"></h3>
                <a class="" href=""> View </a>
                <p class="select_unit"> Select a unit for more information. </p>
            </div>
        </div>
        <div class="col-sm-8">
            <!--<a href="#" class="locate_store">Locate store <i class="fa fa-search"></i></a>-->
            <!--<div class="stores_table">-->
            <!--    <ul id="store_list_container_map">-->
            <!--        <script id="store_list_template_map" type="x-tmpl-mustache/text">-->
            <!--            <li><a class="map_pin_a" href="#" data-value='{{svgmap_region}}/{{slug}}'>{{name}}</a><li>-->
            <!--        </script>-->
            <!--    </ul>-->
            <!--</div>-->
            <div class="map_container">
			    <div class="map">
                    <div id="mapsvg_store_detail"></div>  
                </div>
            </div>
        </div> 
    </div>
</div>

<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
             var regions = {};
             var map = null;
            url = "//codecloud.cdn.speedyrails.net/sites/5a53fafc6e6f645dbb0e0000/application/json/1518478191901/leasing_units.json";
            $.getJSON(url).done(function(data){
                mallData = JSON.stringify(data);
                var mallDataJSON = JSON.parse(mallData);
                log('done fetching mallData from: ' + url);
                // return mallDataJSON.leasing_units;
                var leasing_units = mallDataJSON.leasing_units;
                console.log(leasing_units);
                renderLeasingList('#store_list_building_spec','#store_list_template_map', leasing_units, "A", "Z");
                // console.log(no_pdf);
               
                $.each( leasing_units , function( key, val ) {
                    if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
                        if(!val.store_front_url_abs ||  val.store_front_url_abs.indexOf('missing.png') > -1 || val.store_front_url_abs.length === 0){
                            val.store_front_url_abs = '//codecloud.cdn.speedyrails.net/sites/55ddf3f86e6f640775000000/a22fcf023d728855c6f575ba100806d7/default.jpg'
                        }
                        obj = {};
                        obj["tooltip"] = "<p class='tooltip_name'>"+val.unit_number+"</p>"
                        console.log("val.no_pdf",val.no_pdf);
                        if(val.no_pdf) {
                            obj["popover"] = "<p class='popover_name'>"+val.unit_number+"</p>"
                        }
                        else {
                            obj["popover"] = "<p class='popover_name'>"+val.unit_number+"</p><a href="+ val.leasing_doc + "> View Spec Document </a>"
                        }
                        
                        // obj["attr"] = {}
                        // obj["attr"]["href"] = "/stores/"+val.slug
                        regions[val.svgmap_region] = obj
                    }
                });
                // renderStoreList('#stores_container','#stores_template', stores, "A", "Z");
                show_content();
                var map = $('#mapsvg_store_detail').mapSvg({
                    source: "//mallmaverickdevelopment.com/system/properties/leasing_mapsvgs/000/000/042/original/StVital_-_Map_-_Jan-30-2018_-_Red.svg?1517426277",
                    colors: {stroke: '#aaaaaa', selected: "#F3047A", hover: "#F3047A"},
                    width: 1170,
                    height:600,
                    // viewBox: [520,150,1350,1400],
                    regions: regions,
                    tooltipsMode: 'custom',
                    zoom: true,
                    pan:true,
                    cursor:'pointer',
                    responsive:true,
                    zoomLimit: [0,10],
                    onClick:regionClicked,
                });
                $(".map_tooltip").css({"background-color":"#C607A9", "color" : "#fff", "margin": "5px", "border": "none"});
                $('.map_pin_a').click(function(e){
                    e.preventDefault();
                    var id = $(this).attr('data-value');
                    console.log("id",id);
                    map_pin(id, e, regions);
                
                })
                $('#mapsvg_store_detail').bind('onClick',function(this_obj,e,mapSVG) {
                    console.log("clicked");
                });
                function map_pin(value, e, regions){
                    map.marksHide();
                    value = value.split('/')
                    if (value[0] != null){
                        store = getStoreDetailsBySlug(value[1]);
                        drop_pin(value[0], map, store, e,regions);    
                    }
                }
            });
            
            // var stores = getStoresList(); 
            // renderStoreList('#store_list_building_spec','#store_list_template_map', stores, "A", "Z");
            // regions = {}
            // $.each( stores , function( key, val ) {
            //     if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
            //         if(!val.store_front_url_abs ||  val.store_front_url_abs.indexOf('missing.png') > -1 || val.store_front_url_abs.length === 0){
            //             val.store_front_url_abs = '//codecloud.cdn.speedyrails.net/sites/55ddf3f86e6f640775000000/a22fcf023d728855c6f575ba100806d7/default.jpg'
            //         }
            //         obj = {};
            //         obj["tooltip"] = "<p class='tooltip_name'>"+val.name+"</p>"
            //         obj["popover"] = "<p class='popover_name'>"+val.name+"</p><a href="+ val.leasing + "> View Spec Document </a>"
            //         // obj["attr"] = {}
            //         // obj["attr"]["href"] = "/stores/"+val.slug
            //         regions[val.svgmap_region] = obj
            //     }
            // });
            // renderStoreList('#stores_container','#stores_template', stores, "A", "Z");
            // show_content();
            // var map = $('#mapsvg_store_detail').mapSvg({
            //     source: getSVGMapURL(),
            //     colors: {stroke: '#aaaaaa', selected: "#F3047A", hover: "#F3047A"},
            //     width: 1170,
            //     height:600,
            //     // viewBox: [520,150,1350,1400],
            //     regions: regions,
            //     tooltipsMode: 'custom',
            //     zoom: true,
            //     pan:true,
            //     cursor:'pointer',
            //     responsive:true,
            //     zoomLimit: [0,10]
            // });
            
            
            // init_map(reg);
        }
        function  regionClicked(e,mapsvg){
            var region = this;
            console.log(region);
            console.log("e",e)
        }
        function drop_pin(id, map, store, e, regions){
            console.log("map", map);
            var coords = map.get_coords(id);
            var height = parseInt(coords["height"])
            var width = parseInt(coords["width"])
            var x_offset = (parseInt(width) / 2);
            var y_offset = (parseInt(height) /2);
            $("#"+id).click();
            
            // var svg = $('#mapsvg_store_detail svg')[0];
            // console.log("svg", svg);
            // var element = document.getElementById(id);
            // elBBox = element.getBoundingClientRect();
            // console.log("elBBox",elBBox);
            // console.log("coords",coords);
            // console.log("id data", $("#"+id));
            // var viewport_center_x = 0;
            // var viewport_center_x = 0;
            // viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right) )/2;
            // viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom) )/2;
            // var offset = svg.getBoundingClientRect();
            // var matrix =element.getScreenCTM();
           
            //   page_x = (matrix.a * viewport_center_x) + (matrix.c * viewport_center_y) + matrix.e - offset.left,
            //   page_y = (matrix.b * viewport_center_x) + (matrix.d * viewport_center_y) + matrix.f - offset.top
           
            // console.log("viewport_x",viewport_center_x,viewport_center_y);
            // console.log("page_x",page_x,page_y);
            // pt = svg.createSVGPoint();
            // pt.x = viewport_center_x;
            // pt.y = viewport_center_y;
            // var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
            // console.log("svg points", svgP.x,svgP.y);
            // var new_x = svgP.x/ 2376;
            // var new_y = svgP.y/ 1728;
            // console.log(new_x, new_y);
            // var region = regions[id];
            // map.regionClickHandler(e,region);
            // store={};
            // store.name = "Some name";
            // store.leasing_doc ="/"
            map.showPopover(e,"<p class='popover_name'>"+store.name+"</p><a href="+ store.leasing_doc + "> View Spec Document </a>",[viewport_center_x, viewport_center_y ]);
        
        map.setMarks([{ xy: [coords["x"] - 15 + x_offset, coords["y"] - 55 + y_offset],
            attrs: {
                src:  '//codecloud.cdn.speedyrails.net/sites/57f7f01f6e6f647835890000/image/png/1463000912000/pin2.png',     // image for marker
            },        
        }]);
        map.showTargetPopover(id);
        map.setViewBox(id);
        map.selectRegion(id);
    }
        loadMallDataCached(renderAll); 
    });
    
</script>