<div class="inside_banner">   
    <div class="content_container">
        <div class="inside_banner_content">
            <div class="row">
                <div class="col-md-6">
                    <h1>Centre Map</h1>
                </div>
                <div class="col-md-6 hidden_phone">
                    <h4 class="pull-right">Stores <i class="fa fa-angle-right" aria-hidden="true"></i> Centre Map</h4>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="content_container margin_30">
    <div class="margin_30"></div>
    <div class="row">
        <div class="col-md-12 center hidden_phone">
            <a href="/stores"><div class="directory_btn caps ">Stores</div></a>
            <div class="directory_btn caps active">Centre Map</div>
        </div>
        <div class="col-sm-12 center">
            <a href="/stores"><div class="directory_btn caps directory_back"><i class="fa fa-angle-left" aria-hidden="true"></i> Back to Directory</div></a>
        </div>
    </div>
    <div class="margin_30"></div>
    <div class="row">
        <div class="col-md-12">
            <a href="#" class="dropPin">Locate store <i class="fa fa-search"></i></a>
            <!--<div class="stores_table">-->
            <!--    <ul id="store_list_container_map">-->
            <!--        <script id="store_list_template_map" type="x-tmpl-mustache/text">-->
            <!--            <li><a class="map_pin_a" href="#" data-value='{{svgmap_region}}/{{slug}}'>{{name}}</a><li>-->
            <!--        </script>-->
            <!--    </ul>-->
            <!--</div>-->
            <div class="stores_table">
                <ul id="store_list_container_map">
                    <script id="store_list_template_map" type="x-tmpl-mustache/text">
                        <li><a class="map_pin_a" href="#" store_id="{{id}}" store_name="{{name}}" store_x_coordinate="{{x_coordinate}}" store_y_coordinate="{{y_coordinate}}">{{name}}</a><li>
                    </script>
                </ul>
            </div>
            <div class="map_container">
			    <div class="map">
                    <!--<div id="mapsvg_store_detail"></div>  -->
                    <div id="mapplic" class="mapplic"></div>
                </div>
            </div>
        </div> 
    </div>
</div>

<style>
    .mapplic-pin{
        /*background-color: transparent!important;    */
    }
    /* INTERACTIVE ELEMENTS */
    /* clickable elements */
    .mapplic-clickable:not(g),
    g.mapplic-clickable > * {
    	opacity: 1!important;
    	/*fill: #b7a6bd*/;
    }
    /* hovered elements */
    .mapplic-clickable:not(g):hover,
    g.mapplic-clickable:hover > * {
    	opacity: 1;
    	fill: #c2cfdf;
    }
    
    /* active elements */
    .mapplic-active,
    a.mapplic-active > path,
    g.mapplic-active > * {
    	fill: #c2cfdf;
    	opacity: 1.0 !important;
    }
    .mapplic-coordinates {
        visibility: hidden;
    }
    .mapplic-container {
        background: #fff;
        height: 100%!important;
    }
    .mapplic-zoom-buttons{
        bottom: initial!important;
        top: 0!important;
        left: initial!important;
        right: 0!important;
    }
    .mapplic-popup-link {
        float: left!important;
    }
    .mapplic-tooltip-content {
        overflow: hidden;
        overflow-y: hidden !important;
    }
    .mapplic-hovertip {
        opacity:1!important;
    }
    #nopointer-unitnumbers {
        display:none!important;
    }
</style>

<link href="//codecloud.cdn.speedyrails.net/sites/5ae8c1fe6e6f6473fd160000/text/css/1522163605908/mapplic.css" rel="stylesheet">
<link href="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/css/1485967426000/map.css" rel="stylesheet">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/5ae8c1fe6e6f6473fd160000/text/javascript/1520366143656/mapplic_mmsdk.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>


<script>
    $(document).ready(function(e){
        init(e);
        function renderAll(){
            var stores = getStoresList(); 
            renderStoreList('#store_list_container_map','#store_list_template_map', stores, "A", "Z");
            var mall_json = {};
            var landmarks = {};
            mall_json.mapwidth = "1000";
            mall_json.mapheight = "1000";
            mall_json.categories = [];
            mall_json.levels = [];
            
            // need to add the following for each floor we want to configure.
            _.forEach(floorList(), function(value, key) { 
                var floor_1 = {};
                floor_1.id = value.id;
                floor_1.title = value.title;
                floor_1.map = value.map;
                
                floor_1.show = value.show;
                floor_1.locations = [];
                var stores_on_floors =  _.filter(stores, function(o) {return value.z_index === o.z_coordinate;}); // ['z_coordinate', value.z_index]);
                _.forEach(stores_on_floors, function(val, key) {
                    //for testing limiting the store numbers to vm
                    var temp_val = {};
                    temp_val.id = val.svgmap_region;
                    temp_val.title = val.name;
                    temp_val.about = val.description.substring(0,200);
                    if(val.categories != null) {
                        if(val.categories.length>1){
                        temp_val.category = val.categories[1];
                        }
                        else {
                            temp_val.category = val.categories[0];
                        }
                    }
                    temp_val.link = "/stores/" + val.slug;
                    temp_val.pin = "hidden";
                   
                    
                    //get svg's wifth/height by checking the map
                    var svg_width = 2500;
                    var svg_height = 2500;

                    temp_val.x = val.x_coordinate / svg_width;
                    temp_val.y = val.y_coordinate / svg_height;
                    floor_1.locations.push(temp_val);
                });
                mall_json.levels.push(floor_1);
            });
            
            map = $('#mapplic').mapplic({
            	source: mall_json,
            	height: 900,
            	landmark : true,
            	mapfill:true,
            	minimap: false,
            	sidebar: false,
            	hovertip: true,
            	developer: false,
            	fullscreen : false,
            	clearbutton: false,
            	deeplinking: false,
            	fillcolor : "none",
            	maxscale: 6,
            	skin: 'mapplic-dark',
            	tooltiplabel : 'Info'
            });
            
            map.on('mapready', function(e, self) {
				console.log('Map is ready!');
				mapLoaded(map);
			});
            
        }
        function floorList () {
            var floor_list = [];
            
            var floor_1 = {};
            floor_1.id = "first-floor";
            floor_1.title = "Level One";
            // console.log(getSVGMapURL().split("?")[0])
            floor_1.map =  "https://www.mallmaverick.com/system/site_images/photos/000/039/355/original/St.Vital_-_Leasing_Map_-_May-09-2018.svg"; 
            //"//www.mallmaverick.com/system/site_images/photos/000/037/418/original/Regent_Mall_-_Map_-_March-08-2018_updated.svg";
            // floor_1.minimap = "//codecloud.cdn.speedyrails.net/sites/5a4bb6d36e6f6473fa0a0000/image/png/1513365138000/NorthPark - Dec-15-2017 - Floor 1.png";
            floor_1.z_index = 1;
            floor_1.show = true;
            floor_list.push(floor_1);
            return floor_list;
        }
        function svgList () {
            return _.map(getStoresList(), 'svgmap_region');
        }
        function mapLoaded (map){
            self = map.data('mapplic');
            var svg = document.getElementById('Layer_1');
            // console.log("svg", svg);
            
            //get floors to be visible 
            $(".mapplic-layer").show();
            //go through all the regions and recalculat the locations
            _.forEach(svgList(), function(val, key) {
                
                if(val !== null) {
                    
                    var element = document.getElementById(val);
                    if (element){
                        // console.log(val, element);
                        elBBox = element.getBoundingClientRect();
                        // console.log(elBBox);
                        
                        var viewport_center_x = 0;
                        var viewport_center_y = 0;
                        viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right) )/2;
                        viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom) )/2;
                        pt = svg.createSVGPoint();
                        pt.x = viewport_center_x;
                        pt.y = viewport_center_y;
                        var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                        var new_x = svgP.x/ 2500;
                        var new_y = svgP.y/ 2500;
                        var location = self.getLocationData(val);
                        if(location !== null && location.el){
                            location.x = new_x;
                            location.y =  new_y;
                            self.updateLocation(val);
                        }
                    }
                }
            });
            //find which levels need to be hidden
            hidden_level = _.filter(self.data.levels , function (o){ 
                // console.log (o); 
                return o.show !== true;
            });
            //doing it in a loop for future cases where there are more than two floors
            _.forEach(hidden_level, function(val, key) {
                $(".mapplic-layer[data-floor='"+val.id+"']").hide();
            });
            setTimeout(function() {
                show_content();
            }, 500);
        }
        loadMallDataCached(renderAll); 
        // https://www.mallmaverick.com/system/site_images/photos/000/037/939/original/St.Vital_-_Map_-_Mar-21-2018.svg?1521739249
    });
    function dropPin(svgmap_region) {
        console.log(svgmap_region)
        self = map.data('mapplic');
        self.showLocation(svgmap_region);
    }
</script>