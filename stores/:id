<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/raphael.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/javascripts/mapsvg/jquery.mousewheel.js"></script>
<script type="text/javascript" src="//mallmaverick.cdn.speedyrails.net/system/site_images/photos/000/005/107/original/mallmaverick_svgmap.js?1412885524"></script>
<div class="inside_banner">   
    <div class="content_container">
        <div class="inside_banner_content">
            <div class="row">
                <div id="store_header_container">
                    <script id="store_header_template" type="x-tmpl-mustache/text">
                        <div class="col-sm-6">    
                            <h1> {{name}} </h1>
                        </div>
                        <div class="col-sm-6 hidden_phone">
                            <h4 class="pull-right">Stores <i class="fa fa-angle-right" aria-hidden="true"></i> <a href="/stores">Store Directory</a> <i class="fa fa-angle-right" aria-hidden="true"></i> {{name}}</h4>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="content_container margin_30">
    <div class="margin_30"></div>
    <div class="row store_dets_dir_btns">
        <div class="col-sm-12 center">
            <a href="/stores"><div class="directory_btn caps ">Stores</div></a>
            <a href="/map"><div class="directory_btn caps">Centre Map</div></a>
        </div>
    </div>
    <div class="margin_30"></div>
    <div class="row">
        <div class="col-sm-6">
            <!-- MAP -->
            <div class="store_map_container">
                <div id="mapView">
                    
                </div>
                       <!--<img src="" class="imgMap" id="map_image">                -->
                       <!--     	<div class="marker" id='scroll_to_marker' data-coords="{{map_x_coordinate}}, {{map_y_coordinate}}">-->
                       <!--     	    {{name}}-->
                       <!--         </div>-->
                       <!--         </div>   -->
                       <!--         <div class="store_details_desc hidden_phone">{{{rich_description}}}</div>-->
                     <!--   <div class="zoom_container" id="zoom_container_store">-->
                		   <!-- <img id="zoom_image" src=""/>-->
                		   <!-- <div class="landmarks" data-show-at-zoom="0" data-allow-drag="true"></div>-->
                    	<!--</div>-->
                    	<div id="mapsvg_store_detail" class="mobile_padding"></div>
                <!--<select id="mapList"></select>-->
            </div>
        </div>
        <div class="col-sm-6 border_left">
            <div id="store_details_container">
                <script id="store_details_template" type="x-tmpl-mustache/text">
                    <div class="store_details_logo">
                        <img src="{{store_logo}}"/>
                    </div>
                    <p class="center" style="{{show_phone}}"><span class="store_detail_highlight">Phone:</span> {{phone}}</p>
                    <p class="center" style="{{show_website}}"><span class="store_detail_highlight">Website:</span> {{website}}</p>
                    <p class="center" style="{{show_category}}"><span class="store_detail_highlight">Category:</span> {{store_categories}}</p>
                    <div class="store_description">
                        <p >{{{rich_description}}}</p>
                    </div>
                </script>
            </div>
            <div id="hours" class="grey_line hidden_now">
                <h2 class="details_title">Store Hours</h2>
                <div id="hours_container" class="store_hours_container">
                    <script id="hours_template" type="x-tmpl-mustache/text">
                        <div class="row">
                            <div class="col-xs-5">
                                <span>{{day}}</span>
                            </div>
                            <div class="col-xs-7">
                                <span class="pull-right">{{hour_string}}</span>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
            <div id="promotions" class="grey_line hidden_now">
                <h2 class="details_title">Sales & Promotions</h2>
                <div id="promo_container">
                    <script id="promo_template" type="x-tmpl-mustache/text">
                        <div class="promo_img_container" style="background-image: url({{image_url}})"></div>
                        <div class="promo_content">
                            <h2 class="promo_name"> {{name}} </h2>
                            <h4 class="promo_dates"> {{dates}} </h4>
                            <a class="read_more" href="/promotions/{{slug}}">Read More</a>
                        </div>
                    </script>
                </div>
            </div>
            <div id="jobs" class="grey_line hidden_now">
                <h2 class="details_title">Job Opportunities</h2>
                <div id="jobs_container">
                    <script id="jobs_template" type="x-tmpl-mustache/text">
                        <div class="promo_content">
                            <h2 class="promo_name">{{name}}</h2>
                            <h4 class="promo_dates"> {{dates}} </h4>
                            <a class="read_more" href="/jobs/{{slug}}"><p>Read More</p></a>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .mapplic-pin{
        /*background-color: transparent!important;    */
    }
    /* INTERACTIVE ELEMENTS */
    /* clickable elements */
    .mapplic-clickable:not(g),
    g.mapplic-clickable > * {
    	opacity: 1!important;
    	/*fill: #b7a6bd*/;
    }
    /* hovered elements */
    .mapplic-clickable:not(g):hover,
    g.mapplic-clickable:hover > * {
    	opacity: 1;
    	fill: #343F4B;
    }
    
    /* active elements */
    .mapplic-active,
    a.mapplic-active > path,
    g.mapplic-active > * {
    	fill: #343F4B;
    	opacity: 1.0 !important;
    }
    .mapplic-coordinates {
        visibility: hidden;
    }
    .mapplic-container {
        background: #fff;
    }
    .mapplic-zoom-buttons{
        bottom: initial!important;
        top: 0!important;
        left: initial!important;
        right: 0!important;
    }
    .mapplic-pin.black-pin {
    	background-image: url(' //codecloud.cdn.speedyrails.net/sites/587659fb6e6f641648010000/image/png/1484850466000/show_pin.png');
        background-size: 40px 60px;
        width: 40px;
        height: 60px;
    	margin-top: -55px;
    	margin-left: -10px;
    }
    .mapplic-tooltip-content {
        overflow: hidden;
        overflow-y: hidden !important;
    }
</style>

<link href="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/css/1510935230000/mapplic.css" rel="stylesheet">
<link href="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/css/1485967426000/map.css" rel="stylesheet">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/5a9eeaa46e6f6405fb150000/text/javascript/1520365246170/mapplic_mmsdk.js"></script>
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

<script>
    $(document).ready(function(e){
        init(e);
        // initMappedin();
        function renderAll(){
            // var repo = getRepoDetailsByName("Store Directory Banner");
            // if (repo != undefined) {
            //     var banner = getImageURL(repo.images[0].photo_url);
            //     $(".inside_banner").css({backgroundImage: "url(" + banner + ")"});
            // }
            
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            if(store_details === undefined){
                window.location = "/";
            } else {
                renderStoreDetails('#store_header_container', '#store_header_template', store_details);
                renderStoreDetails("#store_details_container", "#store_details_template", store_details, slug);

                /* HOURS */
                var hour_ids = store_details.store_hours;
                if (hour_ids != null){
                    var hours = getHoursForStoreSlug(store_details.slug).sortBy(function(o){ return o.day_of_week });
                    renderStoreDetailsHours('#hours_container','#hours_template', hours, 'reg_hours');
                    $('#hours').show();
                }
                
                /* MAP */
                // var name = store_details.name;
                // setTimeout(function(){
                //     hightlightStore(name)
                // }, 3000);

                /* PROMOS */
                var store_promo_ids = store_details.promotions
                if(store_promo_ids != null){
                    var store_promos = getPromotionsForIds(store_promo_ids).sortBy(function(o){ return o.start_date });
                    var published_promos = [];
                    $.each(store_promos, function(key, val){
                        today = moment();
                        webDate = moment(val.show_on_web_date)
                        if (today.tz(getPropertyTimeZone()) >= webDate.tz(getPropertyTimeZone())) {
                            published_promos.push(val);
                        } 
                    });
                    if( published_promos.length > 0){
                        renderPromotions("#promo_container","#promo_template", published_promos);
                        $('#promotions').show();
                    }
                }
                
                /* JOBS */
                var store_job_ids = store_details.jobs
                if(store_job_ids != null){
                    var store_jobs = getJobsForIds(store_job_ids).sortBy(function(o){ return o.start_date });
                    var published_jobs = [];
                    $.each( store_jobs , function( key, val ){
                        today = moment();
                        webDate = moment(val.show_on_web_date)
                        if (today.tz(getPropertyTimeZone()) >= webDate.tz(getPropertyTimeZone())) {
                            published_jobs.push(val);
                        } 
                    });
                    if(published_jobs.length > 0){
                        renderJobs('#jobs_container', '#jobs_template', published_jobs);
                        $('#jobs').show();
                    } 
                }
            }
		    var stores = getStoresList();
            var regions = {}
            $.each( stores , function( key, val ) {
                if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
                    obj = {};
                    obj["tooltip"] = "<div class='tooltip_div'><p class='tooltip_name'>"+val.name+"</p></div>"
                    obj["attr"] = {}
                    obj["attr"]["href"] = "/stores/"+val.slug
                    regions[val.svgmap_region] = obj
                }
            });
            console.log(getSVGMapURL())
            console.log(store_details);
            load_map(regions, store_details);
            show_content();
        }
        loadMallDataCached(renderAll); 
    });
    
   
    function floorList () {
            var floor_list = [];
            
            var floor_1 = {};
            floor_1.id = "first-floor";
            floor_1.title = "Level One";
            floor_1.map = getSVGMapURL().split("?")[0];
            //"//www.mallmaverick.com/system/site_images/photos/000/037/418/original/Regent_Mall_-_Map_-_March-08-2018_updated.svg";
            // floor_1.minimap = "//codecloud.cdn.speedyrails.net/sites/5a4bb6d36e6f6473fa0a0000/image/png/1513365138000/NorthPark - Dec-15-2017 - Floor 1.png";
            floor_1.z_index = 1;
            floor_1.show = true;
            floor_list.push(floor_1);
            return floor_list;
        }
        function svgList () {
            return _.map(getStoresList(), 'svgmap_region');
        }
        function mapLoaded (map){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            self = map.data('mapplic');
            var svg = document.getElementById('Layer_x5F_1');
            // console.log("svg", svg);
            
            //get floors to be visible 
            $(".mapplic-layer").show();
            //go through all the regions and recalculat the locations
            _.forEach(svgList(), function(val, key) {
                
                if(val !== null) {
                    
                    var element = document.getElementById(val);
                    if (element){
                        // console.log(val, element);
                        elBBox = element.getBoundingClientRect();
                        // console.log(elBBox);
                        
                        var viewport_center_x = 0;
                        var viewport_center_y = 0;
                        viewport_center_x = (_.toNumber(elBBox.left) + _.toNumber(elBBox.right) )/2;
                        viewport_center_y = (_.toNumber(elBBox.top) + _.toNumber(elBBox.bottom) )/2;
                        // console.log("viewport_x",viewport_center_x,viewport_center_y);
                        pt = svg.createSVGPoint();
                        pt.x = viewport_center_x;
                        pt.y = viewport_center_y;
                        // console.log("pt", pt.x, pt.y)
                        var svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
                        // console.log("svg points", svgP.x,svgP.y);
                        var new_x = svgP.x/ 2500;
                        var new_y = svgP.y/ 2500;
                        var location = self.getLocationData(val);
                        // console.log("nex_x, y", new_x, new_y)
                        if(location !== null && location.el){
                            location.x = new_x;
                            location.y =  new_y;
                            // self.updateLocation(val);
                            if(store_details.svgmap_region == val){
                              location.pin = "black-pin";
                               
                            }
                            self.updateLocation(val);
                            // var location1 = vm.self.getLocationData(val);
                            // console.log("location1",  location1.x ,location1.y);
                            if(store_details.svgmap_region == val){
                                self.showLocation(val);
                                self.addPin(val);
                                
                            }
                        }
                    }
                }
            });
            // console.log("self", vm.self);
            //find which levels need to be hidden
            hidden_level = _.filter(self.data.levels , function (o){ 
                // console.log (o); 
                return o.show !== true;
            });
            //doing it in a loop for future cases where there are more than two floors
            _.forEach(hidden_level, function(val, key) {
                $(".mapplic-layer[data-floor='"+val.id+"']").hide();
            });
            
            setTimeout(function() {
                show_content();
            }, 500);
        }
        
        loadMallDataCached(renderPage);
    });
    function dropPin(svgmap_region) {
        console.log(svgmap_region)
        self = map.data('mapplic');
        self.showLocation(svgmap_region);
    //
</script>